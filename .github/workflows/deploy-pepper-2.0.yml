name: üöÄ Deploy Pepper 2.0 to AWS EC2

on:
  push:
    branches:
      - main
      - production
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/deploy-pepper-2.0.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  EC2_APP_PATH: '/opt/pepper-2.0'
  EC2_DOMAIN: 'pepper20.emtechnologysolutions.com'

jobs:
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL || 'https://pepper20.emtechnologysolutions.com' }}
        run: npm run build

  deploy-backend:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    needs: build-frontend
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo '‚úÖ SSH connection successful'"

      - name: Create backup on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            BACKUP_DIR="$HOME/backups/pepper-2.0"
            mkdir -p "$BACKUP_DIR"
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            
            if [ -d "${{ env.EC2_APP_PATH }}/backend" ]; then
              echo "üì¶ Creating backup..."
              tar -czf "$BACKUP_DIR/backend-$TIMESTAMP.tar.gz" -C "${{ env.EC2_APP_PATH }}/backend" \
                --exclude='node_modules' \
                --exclude='.git' \
                --exclude='cases' \
                --exclude='*.log' \
                .
              echo "‚úÖ Backup created: backend-$TIMESTAMP.tar.gz"
              
              # Keep only last 5 backups
              ls -t "$BACKUP_DIR"/backend-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm || true
            fi
          EOF

      - name: Stop PM2 process
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "pm2 stop pepper-2.0-backend || true"

      - name: Sync backend files to EC2
        run: |
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='cases' \
            --exclude='*.log' \
            --exclude='.env' \
            --exclude='.next' \
            --exclude='frontend' \
            -e "ssh -o StrictHostKeyChecking=no" \
            . ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.EC2_APP_PATH }}/

      - name: Install backend dependencies
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ${{ env.EC2_APP_PATH }}/backend
            echo "üì¶ Installing dependencies..."
            npm ci --production
            echo "‚úÖ Dependencies installed"
          EOF

      - name: Restart PM2 process
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ${{ env.EC2_APP_PATH }}/backend
            echo "üîÑ Restarting PM2..."
            pm2 restart pepper-2.0-backend || pm2 start ecosystem.config.js
            pm2 save
            echo "‚úÖ PM2 restarted"
          EOF

      - name: Wait for application startup
        run: sleep 10

      - name: Health check
        id: health
        run: |
          echo "üîç Waiting for backend to be ready..."
          for i in 1 2 3 4 5 6 7 8 9 10; do
            HEALTH=$(ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:3001/health 2>/dev/null || echo '000'")
            if [ "$HEALTH" = "200" ]; then
              BODY=$(ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "curl -s http://localhost:3001/health")
              echo "health_response=$BODY" >> $GITHUB_OUTPUT
              echo "Health check response: $BODY"
              echo "‚úÖ Health check passed (attempt $i)"
              exit 0
            fi
            echo "   Attempt $i: HTTP $HEALTH, retrying in 5s..."
            sleep 5
          done
          echo "health_response=FAILED (no response after 10 attempts)" >> $GITHUB_OUTPUT
          echo "‚ùå Health check failed: backend did not respond within ~60s"
          exit 1

      - name: Get PM2 logs on failure
        if: failure()
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "=== PM2 status ==="
            pm2 status
            echo ""
            echo "=== PM2 logs (last 50 lines) ==="
            pm2 logs pepper-2.0-backend --lines 50 --nostream
          EOF

      - name: Deployment summary
        if: success()
        run: |
          echo "## ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** Deployed to EC2" >> $GITHUB_STEP_SUMMARY
          echo "- **Domain:** ${{ env.EC2_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** ${{ steps.health.outputs.health_response }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PM2 Status:** Running" >> $GITHUB_STEP_SUMMARY
